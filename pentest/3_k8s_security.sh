#!/bin/bash

# Kubernetes / Minikube Security Testing Script
# Usage: ./3_k8s_security.sh <TARGET_IP> <SSH_KEY_PATH>

TARGET_IP=$1
SSH_KEY=$2
SSH_USER="ubuntu"

if [ -z "$TARGET_IP" ] || [ -z "$SSH_KEY" ]; then
    echo "Usage: $0 <TARGET_IP> <SSH_KEY_PATH>"
    exit 1
fi

echo "Starting Kubernetes Security Testing..."

# Ensure key permissions
chmod 400 "$SSH_KEY"

REMOTE_SCRIPT="k8s_audit.sh"

cat <<EOF > $REMOTE_SCRIPT
#!/bin/bash
echo "Running K8s Security Checks..."

# Helper: Ensure kubectl is available
if ! command -v kubectl &> /dev/null; then
    echo "kubectl not found, trying minikube kubectl..."
    alias kubectl="minikube kubectl --"
fi

# 3.1 Kubernetes API Server Access Validation
echo "----------------------------------------------------------------"
echo "3.1 Kubernetes API Server Access Validation"
echo "Goal: Check if API server allows anonymous access."
echo "Tool: curl"
echo "Explanation:"
echo "  Attempting to access /api/v1/pods without authentication."
echo "  A 401 Unauthorized or 403 Forbidden is good."
echo "----------------------------------------------------------------"
# Usually Minikube API is on 8443
API_URL="https://localhost:8443"
curl -k -s -o /dev/null -w "%{http_code}" \$API_URL/api/v1/pods
echo " (Expected: 401 or 403)"


# 3.2 Kubelet Security Testing
echo "----------------------------------------------------------------"
echo "3.2 Kubelet Security Testing"
echo "Goal: Check Kubelet API (10250) for anonymous access."
echo "Tool: curl"
echo "Explanation:"
echo "  The Kubelet API allows controlling pods. Anonymous access is dangerous."
echo "----------------------------------------------------------------"
curl -k -s -o /dev/null -w "%{http_code}" https://localhost:10250/pods
echo " (Expected: 401 or 403)"


# 3.3 Pod/Workload Security Review
echo "----------------------------------------------------------------"
echo "3.3 Pod/Workload Security Review"
echo "Goal: Check for privileged containers or root users."
echo "Tool: kubectl"
echo "Explanation:"
echo "  Listing pods that are running as privileged."
echo "----------------------------------------------------------------"
minikube kubectl -- get pods -A -o jsonpath='{range .items[*]}{.metadata.name}{" "}{.spec.containers[*].securityContext.privileged}{"\n"}{end}' | grep "true" || echo "No privileged pods found (simple check)."


# 3.4 Kubernetes CIS Benchmark
echo "----------------------------------------------------------------"
echo "3.4 Kubernetes CIS Benchmark"
echo "Goal: Check compliance with CIS Benchmarks."
echo "Tool: kube-bench (needs installation/run)"
echo "Explanation:"
echo "  kube-bench checks K8s deployment against security best practices."
echo "----------------------------------------------------------------"
# We can run kube-bench as a job or binary. For minikube, downloading binary is easiest or running docker container.
# Assuming docker is available (Minikube usually runs in docker or has docker env).
# If running bare metal minikube (none driver), we run binary.
echo "Downloading kube-bench..."
curl -L https://github.com/aquasecurity/kube-bench/releases/download/v0.6.10/kube-bench_0.6.10_linux_amd64.tar.gz -o kube-bench.tar.gz
tar -xvf kube-bench.tar.gz kube-bench
./kube-bench run --targets node,master --version 1.24 # Adjust version as needed
# Note: This might fail if config files are in non-standard locations for minikube. 
# Minikube specific:
# ./kube-bench run --targets node,master --version 1.24 --config-dir cfg --benchmark cis-1.24

echo "K8s Security Checks Completed."
EOF

# Upload and execute
echo "Uploading K8s audit script..."
scp -o StrictHostKeyChecking=no -i "$SSH_KEY" $REMOTE_SCRIPT $SSH_USER@$TARGET_IP:/tmp/$REMOTE_SCRIPT

echo "Executing K8s audit script..."
ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" $SSH_USER@$TARGET_IP "chmod +x /tmp/$REMOTE_SCRIPT && sudo /tmp/$REMOTE_SCRIPT"

rm $REMOTE_SCRIPT
