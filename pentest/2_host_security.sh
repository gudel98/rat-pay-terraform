#!/bin/bash

# Host-Level Security Testing Script (Minikube EC2 Node)
# Usage: ./2_host_security.sh <TARGET_IP> <SSH_KEY_PATH>
# Example: ./2_host_security.sh 10.0.1.5 ./rat-pay.pem

TARGET_IP=$1
SSH_KEY=$2
SSH_USER="ubuntu"

if [ -z "$TARGET_IP" ] || [ -z "$SSH_KEY" ]; then
    echo "Usage: $0 <TARGET_IP> <SSH_KEY_PATH>"
    exit 1
fi

echo "Starting Host-Level Security Testing on $TARGET_IP..."

# Ensure key permissions
chmod 400 "$SSH_KEY"

# Define remote script to run on host
REMOTE_SCRIPT="host_audit.sh"

cat <<EOF > $REMOTE_SCRIPT
#!/bin/bash
echo "Running Host Security Checks on \$(hostname)..."


echo "----------------------------------------------------------------"
echo "[Lynis Scan] - OS Vulnerability & Package Review"
echo "lynis audit system --quick"
echo "----------------------------------------------------------------"
sudo apt install lynis -y
lynis audit system --quick


echo "----------------------------------------------------------------"
echo "[Lynis Scan] - Dockerfile Audit"
echo "lynis audit dockerfile /home/ubuntu/rat-pay/Dockerfile"
echo "----------------------------------------------------------------"
lynis audit dockerfile /home/ubuntu/rat-pay/Dockerfile


echo "----------------------------------------------------------------"
echo "Authentication & Credential Hardening Checks"
echo "grep -E ^PermitRootLogin|^PasswordAuthentication /etc/ssh/sshd_config"
echo "----------------------------------------------------------------"
grep -E "^PermitRootLogin|^PasswordAuthentication" /etc/ssh/sshd_config


echo "----------------------------------------------------------------"
echo "Privilege Escalation Surface Review"
echo "----------------------------------------------------------------"
echo "SUID Binaries:"
find / -perm -4000 -type f 2>/dev/null | head -n 20
echo "... (truncated)"
echo "Sudo Privileges:"
sudo -l


echo "----------------------------------------------------------------"
echo "Logging & Auditing Validation"
echo "systemctl is-active rsyslog || systemctl is-active systemd-journald"
echo "ls -l /var/log/auth.log"
echo "----------------------------------------------------------------"
systemctl is-active rsyslog || systemctl is-active systemd-journald
ls -l /var/log/auth.log
EOF

LYNIS_REPORT="/home/ubuntu/lynis-report.dat"
LYNIS_LOG="/home/ubuntu/lynis.log"

echo "Uploading audit script to target..."
scp -o StrictHostKeyChecking=no -i "$SSH_KEY" $REMOTE_SCRIPT $SSH_USER@$TARGET_IP:/tmp/$REMOTE_SCRIPT

echo "Executing audit script on target..."
ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" $SSH_USER@$TARGET_IP "chmod +x /tmp/$REMOTE_SCRIPT && /tmp/$REMOTE_SCRIPT" | tee reports/2_host_audit_report.txt

echo "Downloading lynis report from target..."
scp -o StrictHostKeyChecking=no -i "$SSH_KEY" $SSH_USER@$TARGET_IP:$LYNIS_REPORT reports/2_lynis_report.dat
scp -o StrictHostKeyChecking=no -i "$SSH_KEY" $SSH_USER@$TARGET_IP:$LYNIS_LOG reports/2_lynis_log.log

echo "Removing audit script and logs from target..."
ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" $SSH_USER@$TARGET_IP "rm /tmp/$REMOTE_SCRIPT && rm $LYNIS_REPORT && rm $LYNIS_LOG"
rm $REMOTE_SCRIPT

echo "====== HOST SECURITY TESTING COMPLETED ======"
echo "Results:"
echo "  - Host Audit Report: reports/2_host_audit_report.txt"
echo "  - Lynis Report: reports/2_lynis_report.dat"
echo "  - Lynis Log: reports/2_lynis_log.log"
echo "============================================="
