#!/bin/bash

# Host-Level Security Testing Script (Minikube EC2 Node)
# Usage: ./2_host_security.sh <TARGET_IP> <SSH_KEY_PATH>
# Example: ./2_host_security.sh 10.0.1.5 ./rat-pay.pem

TARGET_IP=$1
SSH_KEY=$2
SSH_USER="ubuntu"

if [ -z "$TARGET_IP" ] || [ -z "$SSH_KEY" ]; then
    echo "Usage: $0 <TARGET_IP> <SSH_KEY_PATH>"
    exit 1
fi

echo "Starting Host-Level Security Testing on $TARGET_IP..."

# Ensure key permissions
chmod 400 "$SSH_KEY"

# Define remote script to run on host
REMOTE_SCRIPT="host_audit.sh"

cat <<EOF > $REMOTE_SCRIPT
#!/bin/bash
echo "Running Host Security Checks on \$(hostname)..."

# 2.1 OS Vulnerability & Package Review
echo "----------------------------------------------------------------"
echo "2.1 OS Vulnerability & Package Review"
echo "Goal: Identify outdated packages and OS vulnerabilities."
echo "Tool: apt list --upgradable, lynis (if available)"
echo "Explanation:"
echo "  Checking for pending security updates."
echo "----------------------------------------------------------------"
apt list --upgradable 2>/dev/null | grep -i security
# If Lynis is installed/available, run it. 
# sudo apt install lynis -y
# lynis audit system --quick


# 2.2 Authentication & Credential Hardening Checks
echo "----------------------------------------------------------------"
echo "2.2 Authentication & Credential Hardening Checks"
echo "Goal: Verify SSH configuration and user accounts."
echo "Tool: grep /etc/ssh/sshd_config"
echo "Explanation:"
echo "  Checking specific sshd_config settings:"
echo "  - PermitRootLogin (should be no)"
echo "  - PasswordAuthentication (should be no)"
echo "----------------------------------------------------------------"
echo "Checking SSH Config:"
grep -E "^PermitRootLogin|^PasswordAuthentication" /etc/ssh/sshd_config


# 2.3 Privilege Escalation Surface Review
echo "----------------------------------------------------------------"
echo "2.3 Privilege Escalation Surface Review"
echo "Goal: Find potential privilege escalation vectors (SUID binaries, sudo rights)."
echo "Tool: find, sudo -l"
echo "Explanation:"
echo "  - find / -perm -4000: Finds files with SUID bit set."
echo "  - sudo -l: Lists sudo privileges for the current user."
echo "----------------------------------------------------------------"
echo "SUID Binaries:"
find / -perm -4000 -type f 2>/dev/null | head -n 10
echo "... (truncated)"
echo "Sudo Privileges:"
sudo -l


# 2.4 Logging & Auditing Validation
echo "----------------------------------------------------------------"
echo "2.4 Logging & Auditing Validation"
echo "Goal: Ensure system logs are active and auditd is running."
echo "Tool: systemctl status, ls /var/log"
echo "Explanation:"
echo "  - Checking status of rsyslog/journald."
echo "  - Checking existence of auth.log."
echo "----------------------------------------------------------------"
systemctl is-active rsyslog || systemctl is-active systemd-journald
ls -l /var/log/auth.log

echo "Host Security Checks Completed."
EOF

# Upload and execute the script
echo "Uploading audit script to target..."
scp -o StrictHostKeyChecking=no -i "$SSH_KEY" $REMOTE_SCRIPT $SSH_USER@$TARGET_IP:/tmp/$REMOTE_SCRIPT

echo "Executing audit script on target..."
ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" $SSH_USER@$TARGET_IP "chmod +x /tmp/$REMOTE_SCRIPT && /tmp/$REMOTE_SCRIPT"

# Cleanup
rm $REMOTE_SCRIPT
