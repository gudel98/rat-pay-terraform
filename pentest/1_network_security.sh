#!/bin/bash

TARGET_IP=$1
TARGET="rat-pay.online"

if [ -z "$TARGET_IP" ]; then
    echo "Usage: $0 <TARGET_IP>"
    exit 1
fi

echo "Starting Network-Level Security Testing against $TARGET_IP..."

echo "Installing dependencies..."
sudo apt-get update
sudo apt-get install -y nmap sslscan dnsutils


echo "----------------------------------------------------------------"
echo "[Network Map] - Identify open ports and services running on the target."
echo "sudo nmap -Pn -sS -sV -O -n -v $TARGET_IP -oN reports/1_network_map.txt"
echo "  -Pn: No ping (skip host discovery)."
echo "  -sS: TCP SYN scan (stealthy)."
echo "  -p-: Scan all 65535 ports."
echo "  -sV: Probe open ports to determine service/version info."
echo "  -O:  Enable OS detection."
echo "  -n:  No DNS resolution for faster scanning."
echo "----------------------------------------------------------------"
# No port range for demo purposes
sudo nmap -Pn -sS -sV -O -n -v $TARGET_IP -oN reports/1_network_map.txt


echo "----------------------------------------------------------------"
echo "[Firewall & Segmentation Validation] - Verify that only intended ports are accessible."
echo "sudo nmap -Pn -sA -v $TARGET_IP -oN reports/1_firewall_validation.txt"
echo "  -sA: TCP ACK scan."
echo "       Determine if ports are filtered or unfiltered."
echo "       Verify if the Security Group allows unintended access."
echo "----------------------------------------------------------------"
sudo nmap -Pn -sA -v $TARGET_IP -oN reports/1_firewall_validation.txt


echo "----------------------------------------------------------------"
echo "[SSL/TLS Scan] - Check for weak SSL/TLS configurations on exposed services (e.g., HTTPS)."
echo "sslscan $TARGET:443 | tee reports/1_tls_audit.txt"
echo "  - sslscan queries SSL/TLS services to determine supported ciphers and protocols."
echo "  - It highlights weak ciphers (e.g., RC4, DES) and old protocols (SSLv2, SSLv3, TLS 1.0/1.1)."
echo "  - Note: Assuming port 443 is open."
echo "----------------------------------------------------------------"
if nc -z -w 2 $TARGET_IP 443; then
    sslscan $TARGET:443 | tee reports/1_tls_audit.txt
else
    echo "Port 443 not open, skipping TLS test." | tee reports/1_tls_audit.txt
fi


echo "----------------------------------------------------------------"
echo "[DNS] Check if the target exposes DNS or check reverse DNS resolution."
echo "dig @$TARGET_IP google.com | tee reports/1_dns_audit.txt"
echo "nslookup $TARGET_IP | tee reports/1_dns_audit.txt"
echo "----------------------------------------------------------------"
if nc -z -w 2 $TARGET_IP 53; then
    echo "Port 53 is open. Testing for recursion..."
    dig @$TARGET_IP google.com | tee reports/1_dns_audit.txt
else
    echo "Port 53 not open. Checking Reverse DNS..."
    nslookup $TARGET_IP | tee reports/1_dns_audit.txt
fi


echo "====== NETWORK SECURITY TESTING COMPLETED ======"
echo "Results:"
echo "  - Network Map: reports/1_network_map.txt"
echo "  - Firewall Validation: firewall_validation.txt"
echo "  - SSL/TLS Scan: tls_audit.txt"
echo "  - DNS Audit: dns_audit.txt"
echo "================================================"
