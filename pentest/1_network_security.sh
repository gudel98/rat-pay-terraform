#!/bin/bash

# Network-Level Security Testing Script
# Usage: ./1_network_security.sh <TARGET_IP>
# Example: ./1_network_security.sh 10.0.1.5

TARGET_IP=$1

if [ -z "$TARGET_IP" ]; then
    echo "Usage: $0 <TARGET_IP>"
    exit 1
fi

echo "Starting Network-Level Security Testing against $TARGET_IP..."

# install dependencies
echo "Installing dependencies..."
sudo apt-get update
sudo apt-get install -y nmap sslscan dnsutils

# 1.1 Map the Internal Network
echo "----------------------------------------------------------------"
echo "1.1 Map the Internal Network"
echo "Goal: Identify open ports and services running on the target."
echo "Tool: nmap"
echo "Command: nmap -sS -p- -sV -O $TARGET_IP"
echo "Explanation:"
echo "  -sS: TCP SYN scan (stealthy)."
echo "  -p-: Scan all 65535 ports."
echo "  -sV: Probe open ports to determine service/version info."
echo "  -O:  Enable OS detection."
echo "----------------------------------------------------------------"
# Using -Pn to skip host discovery if ICMP is blocked, though in same subnet it should be fine.
nmap -Pn -sS -p- -sV -O $TARGET_IP -oN network_map.txt


# 1.2 Firewall & Segmentation Validation
echo "----------------------------------------------------------------"
echo "1.2 Firewall & Segmentation Validation"
echo "Goal: Verify that only intended ports are accessible."
echo "Tool: nmap"
echo "Command: nmap -sA $TARGET_IP"
echo "Explanation:"
echo "  -sA: TCP ACK scan. It is used to map out firewall rules."
echo "       It helps determine if ports are filtered or unfiltered."
echo "       We verify if the Security Group allows unintended access."
echo "----------------------------------------------------------------"
nmap -Pn -sA $TARGET_IP -oN firewall_validation.txt


# 1.3 TLS and Certificate Testing
echo "----------------------------------------------------------------"
echo "1.3 TLS and Certificate Testing"
echo "Goal: Check for weak SSL/TLS configurations on exposed services (e.g., HTTPS)."
echo "Tool: sslscan"
echo "Command: sslscan $TARGET_IP:443"
echo "Explanation:"
echo "  sslscan queries SSL/TLS services to determine supported ciphers and protocols."
echo "  It highlights weak ciphers (e.g., RC4, DES) and old protocols (SSLv2, SSLv3, TLS 1.0/1.1)."
echo "  Note: Assuming port 443 is open."
echo "----------------------------------------------------------------"
# Check if port 443 is open first
if nc -z -w 2 $TARGET_IP 443; then
    sslscan $TARGET_IP:443 | tee tls_audit.txt
else
    echo "Port 443 not open, skipping TLS test."
fi


# 1.4 DNS and Internal Name Resolution Audits
echo "----------------------------------------------------------------"
echo "1.4 DNS and Internal Name Resolution Audits"
echo "Goal: Check if the target exposes DNS or if we can resolve internal names."
echo "Tool: nslookup, dig"
echo "Explanation:"
echo "  We check if the target responds to DNS queries (port 53)."
echo "  We also check reverse DNS resolution."
echo "----------------------------------------------------------------"
# Check if port 53 (UDP/TCP) is open
if nc -z -w 2 $TARGET_IP 53; then
    echo "Port 53 is open. Testing for recursion..."
    dig @$TARGET_IP google.com
else
    echo "Port 53 not open. Checking Reverse DNS..."
    nslookup $TARGET_IP
fi

echo "Network Security Testing Completed."
